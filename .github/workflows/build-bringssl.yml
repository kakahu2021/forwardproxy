name: Build BoringSSL with Naive Support

on:
  push:
    branches: [naive]
    paths-ignore: [README.md]
  release:
    types: [created]

defaults:
  run:
    shell: bash

jobs:
  build_caddy_with_naive:
    runs-on: ubuntu-22.04
    env:
      BUNDLE: caddy-forwardproxy-naive
      BORINGSSL_BRANCH: master
      BORINGSSL_DIR: ${{ github.workspace }}/boringssl
      LIBOQS_DIR: ${{ github.workspace }}/liboqs

    steps:
      # 检出代码库
      - uses: actions/checkout@v4
      
      # 设置Go环境
      - uses: actions/setup-go@v5
        with:
          go-version: ^1.21.9

      # 安装编译依赖
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake gcc ninja-build libunwind-dev pkg-config python3 golang-cfssl

      # 安装 liboqs
      - name: Install liboqs
        run: |
          rm -rf liboqs
          git clone --branch main --single-branch --depth 1 https://github.com/open-quantum-safe/liboqs.git
          cd liboqs
          mkdir build && cd build
          cmake -G"Ninja" -DCMAKE_INSTALL_PREFIX=/usr/local ..
          ninja
          sudo ninja install

      # 构建 BoringSSL
      - name: Build BoringSSL with Naive Support
        run: |
          rm -rf boringssl
          git clone https://github.com/open-quantum-safe/boringssl.git
          cd boringssl
          git checkout $BORINGSSL_BRANCH
          mkdir build && cd build
          cmake -GNinja -DCMAKE_PREFIX_PATH=/usr/local ..
          ninja
